# Архитектура системы

## Общая схема

```
┌─────────────────────────────────────────────────────────────────┐
│                         ПОЛЬЗОВАТЕЛИ                             │
│  (Администраторы, Диспетчеры, Техники, Клиенты)                 │
└──────────────────────────┬──────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────────┐
│                    FRONTEND (React + Vite)                       │
│                      http://localhost:3000                       │
│  - Дашборд                                                       │
│  - Управление заявками                                           │
│  - Расписание                                                    │
│  - Управление пользователями                                     │
└──────────────────────────┬──────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────────┐
│                   KONG API GATEWAY                               │
│                  http://localhost:8000                           │
│                                                                   │
│  Плагины:                                                        │
│  - JWT Authentication                                            │
│  - CORS                                                          │
│  - Rate Limiting                                                 │
│  - Request Transformation                                        │
│  - Logging                                                       │
└─────────────┬───────────────────────────────────────────────────┘
              │
              ├──────────────────────────────────────────┐
              │                                          │
              ▼                                          ▼
┌─────────────────────────┐              ┌─────────────────────────┐
│   AUTH SERVICE          │              │   USERS SERVICE         │
│   Port: 3001            │              │   Port: 3002            │
│                         │              │                         │
│ - Регистрация           │              │ - CRUD пользователей    │
│ - Вход/Выход            │              │ - Управление техниками  │
│ - JWT токены            │              │ - Профили               │
│ - Сброс пароля          │              │                         │
└─────────────────────────┘              └─────────────────────────┘
              │                                          │
              ▼                                          ▼
┌─────────────────────────┐              ┌─────────────────────────┐
│   TASKS SERVICE         │              │  SCHEDULE SERVICE       │
│   Port: 3003            │              │   Port: 3004            │
│                         │              │                         │
│ - Заявки (Orders)       │              │ - Расписание            │
│ - Задачи (Tasks)        │              │ - Календарь             │
│ - Статусы               │              │ - Доступность техников  │
│ - Назначение техников   │              │                         │
└─────────────────────────┘              └─────────────────────────┘
              │                                          │
              ▼                                          ▼
┌─────────────────────────┐              ┌─────────────────────────┐
│ NOTIFICATIONS SERVICE   │              │  REPORTS SERVICE        │
│   Port: 3005            │              │   Port: 3006            │
│                         │              │                         │
│ - Push уведомления      │              │ - Отчеты по задачам     │
│ - Email уведомления     │              │ - Аналитика             │
│ - SMS (опционально)     │              │ - Метрики производит.   │
│                         │              │                         │
└─────────────────────────┘              └─────────────────────────┘
              │                                          │
              └──────────────┬───────────────────────────┘
                             │
                             ▼
            ┌────────────────────────────────────┐
            │                                    │
            ▼                                    ▼
┌─────────────────────────┐      ┌─────────────────────────┐
│    POSTGRESQL           │      │       REDIS             │
│    Port: 5432           │      │      Port: 6379         │
│                         │      │                         │
│ - users                 │      │ - Кеш                   │
│ - technicians           │      │ - Сессии                │
│ - clients               │      │ - Real-time данные      │
│ - orders                │      │ - JWT blacklist         │
│ - tasks                 │      │                         │
│ - schedules             │      │                         │
│ - notifications         │      │                         │
│ - reports               │      │                         │
└─────────────────────────┘      └─────────────────────────┘
```

## Поток данных

### 1. Аутентификация

```
Пользователь → Frontend → Kong → Auth Service → PostgreSQL
                  ↑                    ↓
                  └──────── JWT Token ─┘
```

### 2. Создание заявки

```
Клиент → Frontend → Kong (JWT) → Tasks Service → PostgreSQL
                                       ↓
                                 Notifications Service → Redis/Email
                                       ↓
                                 Schedule Service → Назначение техника
```

### 3. Обновление статуса

```
Техник → Frontend → Kong (JWT) → Tasks Service → PostgreSQL
                                       ↓
                                 Order Status History
                                       ↓
                                 Notifications → Клиент
```

## Микросервисы

### Auth Service (3001)

**Отвечает за:**
- Аутентификацию пользователей
- Генерацию JWT токенов
- Восстановление паролей

**Технологии:**
- Node.js + Express + TypeScript
- bcrypt для хеширования паролей
- jsonwebtoken для JWT
- Joi для валидации

**Зависимости:**
- PostgreSQL (users таблица)
- Redis (blacklist токенов)

### Users Service (3002)

**Отвечает за:**
- CRUD операции с пользователями
- Управление профилями техников
- Управление клиентами

**Технологии:**
- Node.js + Express + TypeScript

**Зависимости:**
- PostgreSQL (users, technicians, clients)
- Redis (кеш профилей)

### Tasks Service (3003)

**Отвечает за:**
- Управление заявками (orders)
- Управление задачами (tasks)
- Отслеживание статусов
- Назначение техников

**Технологии:**
- Node.js + Express + TypeScript

**Зависимости:**
- PostgreSQL (orders, tasks, order_status_history)
- Redis (real-time обновления)

### Schedule Service (3004)

**Отвечает за:**
- Расписание техников
- Календарь задач
- Проверку доступности

**Технологии:**
- Node.js + Express + TypeScript

**Зависимости:**
- PostgreSQL (schedules)
- Redis (кеш расписаний)

### Notifications Service (3005)

**Отвечает за:**
- Push уведомления
- Email уведомления
- SMS уведомления (опционально)

**Технологии:**
- Node.js + Express + TypeScript

**Зависимости:**
- PostgreSQL (notifications)
- Redis (очередь уведомлений)

### Reports Service (3006)

**Отвечает за:**
- Генерацию отчетов
- Аналитику
- Метрики производительности

**Технологии:**
- Node.js + Express + TypeScript

**Зависимости:**
- PostgreSQL (все таблицы)
- Redis (кеш отчетов)

## База данных

### PostgreSQL

**Основные таблицы:**

1. **users** - пользователи системы (все роли)
2. **technicians** - расширенная информация о техниках
3. **clients** - информация о клиентах
4. **orders** - заявки от клиентов
5. **tasks** - задачи для техников
6. **schedules** - расписание работы техников
7. **notifications** - уведомления
8. **task_comments** - комментарии к задачам
9. **order_status_history** - история изменения статусов
10. **reports** - отчеты о выполненных работах

### Redis

**Использование:**

- Кеширование данных (профили, расписания)
- JWT token blacklist
- Сессии пользователей
- Real-time обновления
- Очереди уведомлений

## Kong API Gateway

### Конфигурация (kong.yaml)

**Сервисы:**
- auth-service
- users-service
- tasks-service
- schedule-service
- notifications-service
- reports-service
- frontend-service

**Плагины:**

1. **CORS** - разрешение кросс-доменных запросов
2. **JWT** - аутентификация через JWT токены
3. **Rate Limiting** - ограничение частоты запросов
4. **Request Transformer** - модификация запросов
5. **File Log** - логирование запросов
6. **Correlation ID** - трассировка запросов

## Безопасность

### Уровни защиты

1. **Kong Gateway Level:**
   - CORS защита
   - Rate limiting
   - JWT валидация
   - Request size limiting

2. **Application Level:**
   - Валидация входных данных (Joi)
   - Параметризованные SQL запросы
   - Хеширование паролей (bcrypt)
   - HTTPS в production

3. **Database Level:**
   - Разделение прав доступа
   - Индексы для производительности
   - Регулярные backup'ы

## Масштабирование

### Горизонтальное масштабирование

Каждый микросервис можно масштабировать независимо:

```yaml
docker-compose scale tasks-service=3
```

### Вертикальное масштабирование

Увеличение ресурсов в docker-compose.yml:

```yaml
services:
  tasks-service:
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
```

## Мониторинг

### Health Checks

Каждый сервис имеет `/health` endpoint:

```bash
curl http://localhost:8000/api/auth/../health
```

### Логирование

- Kong: `/var/log/kong/access.log`
- Сервисы: stdout/stderr через Docker logs

## Развертывание

### Development

```bash
docker compose up -d
```

### Production

Рекомендации:
1. Использовать Kubernetes для оркестрации
2. Настроить CI/CD pipeline
3. Использовать внешние managed базы данных
4. Настроить мониторинг (Prometheus + Grafana)
5. Настроить централизованное логирование (ELK Stack)
6. Использовать SSL/TLS сертификаты
7. Настроить автомасштабирование
